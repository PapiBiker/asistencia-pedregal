(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const c of t.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function f(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(e){if(e.ep)return;e.ep=!0;const t=f(e);fetch(e.href,t)}})();const E="https://asistencia-backend-production-53df.up.railway.app";document.addEventListener("DOMContentLoaded",()=>{if(!window.location.href.includes("login.html")){const s=localStorage.getItem("token"),e=localStorage.getItem("usuario_id"),t=localStorage.getItem("perfil");(!s||!e||!t)&&(alert("Sesi√≥n expirada o inv√°lida. Inicia sesi√≥n."),window.location.href="login.html")}if(window.location.pathname.includes("login.html")||window.location.pathname==="/"){const s=document.getElementById("loginForm");s&&s.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("usuario").value.trim(),c=document.getElementById("password").value.trim(),a=document.getElementById("errorMessage");if(!t||!c){a&&(a.innerText="Completa todos los campos.");return}try{const l=await fetch(`${E}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({usuario:t,password:c})});if(l.ok){const r=await l.json();localStorage.setItem("token",r.token),localStorage.setItem("usuario_id",r.id),localStorage.setItem("perfil",r.perfil),localStorage.setItem("dni",r.dni),window.location.href="asistencia.html"}else{const r=await l.json();a&&(a.innerText=r.error||"Error de login.")}}catch(l){console.error("Error en login:",l),a&&(a.innerText="Error en la conexi√≥n.")}})}if(window.location.pathname.includes("asistencia.html")){let r=function(){if(t.readyState===t.HAVE_ENOUGH_DATA&&t.videoWidth>0&&t.videoHeight>0){const o=document.createElement("canvas");o.width=t.videoWidth,o.height=t.videoHeight;const i=o.getContext("2d");i.drawImage(t,0,0,o.width,o.height);const m=i.getImageData(0,0,o.width,o.height),n=jsQR(m.data,o.width,o.height);if(n){const d=n.data;c&&(c.innerText=`C√≥digo QR detectado: ${d}`),I(d,s).finally(()=>{requestAnimationFrame(r)})}else requestAnimationFrame(r)}else requestAnimationFrame(r)},g=function(o){const i=document.getElementById("toast");i&&(i.textContent=o,i.className="toast show",setTimeout(()=>{i.className="toast"},3e3))},h=function(){new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play().catch(i=>console.error("Error reproduciendo sonido:",i))};var w=r,u=g,f=h;const s=localStorage.getItem("usuario_id"),e=document.getElementById("dniInput"),t=document.getElementById("qrScanner"),c=document.getElementById("result"),a=document.getElementById("errorMessage");if(!s){alert("Usuario no identificado."),window.location.href="login.html";return}l();async function l(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{const o=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});t.srcObject=o,t.setAttribute("playsinline",!0),t.play(),requestAnimationFrame(r)}catch(o){console.warn("No se pudo acceder a la c√°mara:",o),a&&(a.innerText="No se pudo acceder a la c√°mara."),e&&(e.disabled=!1)}else a&&(a.innerText="Tu navegador no soporta c√°mara."),e&&(e.disabled=!1)}async function I(o,i){try{const m=await fetch(`${E}/asistencia/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({dni:o,usuario_id:i})});if(m.ok){const n=await m.json(),d=document.getElementById("nombre"),p=document.getElementById("fechaHora"),y=document.getElementById("errorMessage");d&&(d.innerText=`‚úÖ Asistencia registrada para: ${n.nombre}`),p&&(p.innerText=`üìÖ Fecha: ${n.fecha} üïë Hora: ${n.hora}`),y&&(y.innerText=""),g(`‚úÖ ${n.nombre} registrado`),h()}else{const n=await m.json(),d=document.getElementById("errorMessage");d&&(d.innerText=n.error||"Error al registrar asistencia."),e&&(e.value=o),g("‚ùå Error al registrar asistencia")}}catch(m){console.error("Error al registrar asistencia:",m);const n=document.getElementById("errorMessage");n&&(n.innerText="Error en la conexi√≥n."),e&&(e.value=o),g("‚ùå Error en la conexi√≥n")}}}});
